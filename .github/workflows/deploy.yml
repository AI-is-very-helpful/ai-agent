name: Deploy Azure Functions (Python)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: docs-ai-agent
  AZURE_FUNCTIONAPP_PACKAGE_PATH: "."
  PYTHON_VERSION: "3.12"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 핵심: requirements.txt를 "배포 패키지에 포함될 위치"에 설치
      - name: Install dependencies into .python_packages (recommended for Linux Consumption)
        run: |
          python -m pip install --upgrade pip
          mkdir -p .python_packages/lib/site-packages
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"
          python -c "import sys; print('python', sys.version)"
          echo "Installed packages:"
          python -m pip list | head -n 50

      # 선택: ai-agent CLI가 실제로 들어갔는지 빠르게 검증 (실패하면 여기서 바로 알 수 있음)
      - name: Smoke test - ai-agent exists
        run: |
          python -c "import shutil; print('ai-agent path:', shutil.which('ai-agent'))"
          ai-agent --help | head -n 20

      # 배포: RBAC 또는 publish profile 중 하나를 사용
      #  - RBAC를 이미 쓰고 있다면 azure/login@v2로 로그인 단계가 필요
      #  - publish profile 방식을 쓰고 있다면 아래 login 단계는 제거 가능
      - name: Azure Login (RBAC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          # 아래 두 값은 "이미 .python_packages를 포함해서 배포"할 것이므로 보통 false 유지
          # (원격 빌드/오릭스 빌드를 켜고 싶으면 true로 변경 가능하지만, 지금 단계에선 이 패턴이 가장 안정적)
          scm-do-build-during-deployment: false
          enable-oryx-build: false
          remote-build: false
